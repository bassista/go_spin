name: Go Coverage Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run tests with coverage
        run: |
          mkdir -p coverage
          go test ./... -coverprofile=coverage/coverage.out -covermode=set
          go tool cover -func=coverage/coverage.out > coverage/coverage.txt

      - name: Extract total coverage
        id: cov
        run: |
          total=$(grep -E "^total:" coverage/coverage.txt | awk '{print $3}' | sed 's/%//')
          echo "percentage=$total" >> $GITHUB_OUTPUT

      - name: Prepare public directory
        run: mkdir -p public

      - name: Generate badge
        run: |
          pct=${{ steps.cov.outputs.percentage }}
          color="red"
          if (( $(echo "$pct > 60" | bc -l) )); then color="yellow"; fi
          if (( $(echo "$pct > 75" | bc -l) )); then color="green"; fi
          if (( $(echo "$pct > 90" | bc -l) )); then color="brightgreen"; fi
          echo "<img src=\"https://img.shields.io/badge/Coverage-$pct%25-$color\"/>" > public/badge.html

      - name: Copy coverage text file
        run: cp coverage/coverage.txt public/

      - name: Generate index.html (safe mode)
        run: |
          badge=$(cat public/badge.html)

          echo "<!DOCTYPE html>" > public/index.html
          echo "<html lang=\"it\">" >> public/index.html
          echo "<head>" >> public/index.html
          echo "<meta charset=\"UTF-8\">" >> public/index.html
          echo "<title>Go Coverage Report</title>" >> public/index.html
          echo "<style>" >> public/index.html
          echo "body { font-family: Arial; background: #f4f6f8; margin:0 }" >> public/index.html
          echo "header { background:#24292f; color:#fff; padding:20px; text-align:center }" >> public/index.html
          echo ".container { max-width:900px; margin:30px auto; background:#fff; padding:25px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1) }" >> public/index.html
          echo "pre { background:#f3f3f3; padding:15px; border:1px solid #ddd; border-radius:6px }" >> public/index.html
          echo ".center { text-align:center }" >> public/index.html
          echo "</style>" >> public/index.html
          echo "</head>" >> public/index.html
          echo "<body>" >> public/index.html
          echo "<header><h1>Go Coverage Report</h1></header>" >> public/index.html
          echo "<div class=\"container\">" >> public/index.html

          echo "<h2>ðŸ“Š Coverage Badge</h2>" >> public/index.html
          echo "<div class=\"center\">$badge</div>" >> public/index.html

          echo "<h2>ðŸ“‘ Coverage Table</h2>" >> public/index.html
          echo "<pre>" >> public/index.html
          cat public/coverage.txt >> public/index.html
          echo "</pre>" >> public/index.html

          echo "</div>" >> public/index.html
          echo "</body>" >> public/index.html
          echo "</html>" >> public/index.html

      - name: Generate PNG badge
        run: |
          pct=${{ steps.cov.outputs.percentage }}
          color="red"
          if (( $(echo "$pct > 60" | bc -l) )); then color="yellow"; fi
          if (( $(echo "$pct > 75" | bc -l) )); then color="green"; fi
          if (( $(echo "$pct > 90" | bc -l) )); then color="brightgreen"; fi

          curl -L "https://img.shields.io/badge/Coverage-${pct}%25-${color}.png" \
            -o public/coverage.png

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public
                      
  deploy:
    runs-on: ubuntu-latest
    needs: coverage

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4